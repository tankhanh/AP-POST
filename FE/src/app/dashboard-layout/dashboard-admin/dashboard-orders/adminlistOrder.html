<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 fw-bold">üì¶ Danh s√°ch ƒë∆°n h√†ng c·ªßa b·∫°n</h2>
    <!-- N√∫t T·∫°o ƒë∆°n h√†ng m·ªõi -->
    <a
      routerLink="/admin/order/create"
      class="btn btn-success btn-lg shadow-sm d-flex align-items-center gap-2"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        fill="currentColor"
        class="bi bi-plus-circle"
        viewBox="0 0 16 16"
      >
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
        <path
          d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"
        />
      </svg>
      <span class="fw-semibold">T·∫°o ƒë∆°n h√†ng m·ªõi</span>
    </a>
  </div>

  <!-- Filter Card -->
  <div class="card mb-4 p-3 shadow-sm">
    <form class="row g-3 align-items-end">
      <!-- Status pill -->
      <div class="col-md-3">
        <label class="form-label d-block mb-1">Tr·∫°ng th√°i</label>
        <div class="dropdown">
          <button
            class="btn btn-danger btn-sm btn-outline-secondary dropdown-toggle w-100"
            type="button"
            data-bs-toggle="dropdown"
          >
            Ch·ªçn tr·∫°ng th√°i ({{ filters.status.length }})
          </button>
          <ul class="dropdown-menu p-2" style="min-width: 180px">
            <li *ngFor="let s of statusOptions">
              <div class="form-check mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [id]="s.value"
                  [checked]="filters.status.includes(s.value)"
                  (change)="toggleStatusFilter(s.value)"
                />
                <label class="form-check-label small" [for]="s.value">{{ s.label }}</label>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- C√°c input l·ªçc kh√°c -->
      <div class="col-md-2">
        <label class="form-label">T·ª´ ng√†y</label>
        <input
          type="date"
          class="form-control"
          [(ngModel)]="filters.fromDate"
          name="fromDate"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">ƒê·∫øn ng√†y</label>
        <input
          type="date"
          class="form-control"
          [(ngModel)]="filters.toDate"
          name="toDate"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">Gi√° t·ª´</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="filters.minPrice"
          name="minPrice"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">Gi√° ƒë·∫øn</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="filters.maxPrice"
          name="maxPrice"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">T√¨m ki·∫øm</label>
        <input
          type="text"
          class="form-control"
          placeholder="M√£ ƒë∆°n"
          [(ngModel)]="filters.search"
          name="search"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">Ng∆∞·ªùi nh·∫≠n</label>
        <input
          type="text"
          class="form-control"
          placeholder="T√™n ng∆∞·ªùi nh·∫≠n"
          [(ngModel)]="filters.receiverName"
          name="receiverName"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">SƒêT ng∆∞·ªùi nh·∫≠n</label>
        <input
          type="text"
          class="form-control"
          placeholder="SƒêT ng∆∞·ªùi nh·∫≠n"
          [(ngModel)]="filters.receiverPhone"
          name="receiverPhone"
          (ngModelChange)="applyFilters()"
        />
      </div>
    </form>
  </div>

  <!-- Orders Table -->
  <table class="table table-bordered table-hover align-middle text-center">
    <thead class="table-light">
      <tr>
        <th>M√£ ƒë∆°n</th>
        <th>Ng∆∞·ªùi nh·∫≠n</th>
        <th>ƒêi·ªán tho·∫°i</th>
        <th>Gi√° tr·ªã</th>
        <th>Tr·∫°ng th√°i</th>
        <th>Ng√†y t·∫°o</th>
        <th>Ng√†y c·∫≠p nh·∫≠t</th>
        <th>Thao t√°c</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let order of pagedOrders()">
        <tr (click)="toggleExpand(order._id)" [class.table-primary]="expandedOrderId === order._id " style="cursor: pointer">
          <td>{{ order._id }}</td>
          <td>{{ order.receiverName }}</td>
          <td>{{ order.receiverPhone }}</td>
          <td>{{ order.totalPrice | number : '1.0-0' }}</td>
          <td [ngClass]="statusClass(order.status)">{{ statusText(order.status) }}</td>
          <td>{{ order.createdAt | date : 'short' }}</td>
          <td>{{ order.updatedAt | date : 'short' }}</td>
          <td>
            <button
              *ngIf="canEdit(order)"
              class="btn btn-danger btn-sm py-2 px-3 me-1"
              [routerLink]="['/admin/order/edit', order._id]"
              (click)="$event.stopPropagation()"
            >
              S·ª≠a
            </button>
            <button
              *ngIf="canDelete(order)"
              class="btn btn-danger btn-sm py-2 px-3"
              (click)="deleteOrder(order._id, $event)"
            >
              X√≥a
            </button>
          </td>
        </tr>
        <!-- Chi ti·∫øt m·ªü r·ªông -->
        <tr *ngIf="expandedOrderId === order._id">
          <td colspan="8">
            <div class="bg-dark text-white p-3 rounded-3">
              <h6 class="fw-bold text-primary mb-3">Chi ti·∫øt ƒë∆°n h√†ng</h6>
              <div class="row">
                <div class="col-md-6">
                  <p><strong class="text-warning">Ng∆∞·ªùi g·ª≠i:</strong> {{ order.senderName }}</p>
                  <p>
                    <strong class="text-warning">ƒê·ªãa ch·ªâ l·∫•y h√†ng:</strong>
                    {{ order.pickupAddressId?.address }},
                    {{ order.pickupAddressId?.communeId?.name }},
                    {{ order.pickupAddressId?.provinceId?.name }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p><strong class="text-warning">Ng∆∞·ªùi nh·∫≠n:</strong> {{ order.receiverName }}</p>
                  <p>
                    <strong class="text-warning">ƒê·ªãa ch·ªâ giao:</strong>
                    {{ order.deliveryAddressId?.address }},
                    {{ order.deliveryAddressId?.communeId?.name }},
                    {{ order.deliveryAddressId?.provinceId?.name }}
                  </p>
                </div>
              </div>
              <hr class="border-secondary" />
              <p>
                <strong class="text-warning">Tr·∫°ng th√°i:</strong>
                <span [ngClass]="statusClass(order.status)"> {{ statusText(order.status) }} </span>
              </p>
              <p>
                <strong>D·ªãch v·ª•:</strong> {{ order.serviceCode }} | <strong>COD:</strong>
                {{ order.codValue | number }} ƒë | <strong>Ph√≠ ship:</strong>
                {{ order.shippingFee | number }} ƒë | <strong>Tr·ªçng l∆∞·ª£ng:</strong>
                {{ order.weightKg }} kg
              </p>

              <div *ngIf="order.items?.length">
                <h6 class="mt-3 text-info">Danh s√°ch h√†ng h√≥a</h6>
                <table class="table table-sm table-bordered table-striped mt-2">
                  <thead>
                    <tr>
                      <th>T√™n s·∫£n ph·∫©m</th>
                      <th>S·ªë l∆∞·ª£ng</th>
                      <th>ƒê∆°n gi√°</th>
                      <th>Th√†nh ti·ªÅn</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let it of order.items">
                      <td>{{ it.productName }}</td>
                      <td>{{ it.quantity }}</td>
                      <td>{{ it.price | number }} ƒë</td>
                      <td>{{ it.quantity * it.price | number }} ƒë</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div *ngIf="filteredOrders.length === 0" class="alert alert-info text-center mt-3">
    Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o.
  </div>

  <nav *ngIf="filteredOrders.length > pageSize">
    <ul class="pagination justify-content-center mt-3">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="changePage(currentPage - 1)">Tr∆∞·ªõc</button>
      </li>
      <li class="page-item" *ngFor="let p of totalPages()" [class.active]="p === currentPage">
        <button class="page-link" (click)="changePage(p)">{{ p }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages().length">
        <button class="page-link" (click)="changePage(currentPage + 1)">Sau</button>
      </li>
    </ul>
  </nav>
</div>
