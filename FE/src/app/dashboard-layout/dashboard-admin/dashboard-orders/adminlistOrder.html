<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 fw-bold">Danh sách đơn hàng của bạn</h2>
    <a
      routerLink="/admin/order/create"
      class="btn btn-success btn-lg shadow-sm d-flex align-items-center gap-2"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        fill="currentColor"
        class="bi bi-plus-circle"
        viewBox="0 0 16 16"
      >
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
        <path
          d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"
        />
      </svg>
      <span class="fw-semibold">Tạo đơn hàng mới</span>
    </a>
  </div>

  <!-- Filter Card -->
  <div class="card mb-4 p-3 shadow-sm">
    <form class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label d-block mb-1">Trạng thái</label>
        <div class="dropdown">
          <button
            class="btn btn-outline-secondary dropdown-toggle w-100 btn-sm"
            type="button"
            data-bs-toggle="dropdown"
          >
            Chọn trạng thái ({{ filters.status.length }})
          </button>
          <ul class="dropdown-menu p-2" style="min-width: 200px">
            <li *ngFor="let s of statusOptions">
              <div class="form-check mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [id]="s.value"
                  [checked]="filters.status.includes(s.value)"
                  (change)="toggleStatusFilter(s.value)"
                />
                <label class="form-check-label small" [for]="s.value">{{ s.label }}</label>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <div class="col-md-2">
        <label class="form-label">Từ ngày</label>
        <input
          type="date"
          class="form-control"
          [(ngModel)]="filters.fromDate"
          name="fromDate"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">Đến ngày</label>
        <input
          type="date"
          class="form-control"
          [(ngModel)]="filters.toDate"
          name="toDate"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">Giá từ</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="filters.minPrice"
          name="minPrice"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-2">
        <label class="form-label">Giá đến</label>
        <input
          type="number"
          class="form-control"
          [(ngModel)]="filters.maxPrice"
          name="maxPrice"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">Tìm kiếm mã vận đơn</label>
        <input
          type="text"
          class="form-control"
          placeholder="VD: HN123456..."
          [(ngModel)]="filters.search"
          name="search"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">Người nhận</label>
        <input
          type="text"
          class="form-control"
          placeholder="Tên người nhận"
          [(ngModel)]="filters.receiverName"
          name="receiverName"
          (ngModelChange)="applyFilters()"
        />
      </div>
      <div class="col-md-3">
        <label class="form-label">SĐT người nhận</label>
        <input
          type="text"
          class="form-control"
          placeholder="SĐT"
          [(ngModel)]="filters.receiverPhone"
          name="receiverPhone"
          (ngModelChange)="applyFilters()"
        />
      </div>
    </form>
  </div>

  <!-- Orders Table -->
  <table class="table table-bordered table-hover align-middle text-center">
    <thead class="table-light">
      <tr>
        <th>Mã vận đơn</th>
        <th>Người nhận</th>
        <th>Điện thoại</th>
        <th>Giá trị</th>
        <th>Trạng thái</th>
        <th>Ngày tạo</th>
        <th>Ngày cập nhật</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let order of pagedOrders()">
        <tr
          (click)="toggleExpand(order._id)"
          [class.table-primary]="expandedOrderId === order._id"
          style="cursor: pointer"
        >
          <!-- Cột Mã vận đơn + Copy -->
          <td class="position-relative">
            <div class="d-flex align-items-center justify-content-center gap-2">
              <span class="fw-bold fs-5 text-warning">{{ order.waybill || '—' }}</span>
              <button
                *ngIf="order.waybill"
                class="btn btn-sm btn-dark p-1"
                title="Copy mã vận đơn"
                (click)="copyWaybill(order.waybill, $event)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"
                  />
                  <path
                    d="M9.5 1a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1-.5-.5v-4z"
                  />
                </svg>
              </button>
            </div>
            <small class="text-muted d-block">({{ order._id }})</small>

            <!-- Hiệu ứng "Đã copy!" -->
            <div
              *ngIf="copiedWaybill === order.waybill"
              class="position-absolute top-50 start-100 translate-middle badge rounded-pill bg-success shadow-sm"
              style="font-size: 0.75rem; z-index: 10"
            >
              Đã copy!
            </div>
          </td>

          <td>{{ order.receiverName }}</td>
          <td>{{ order.receiverPhone }}</td>
          <td>{{ order.totalPrice | number }} đ</td>
          <td>
            <span [ngClass]="statusClass(order.status)">{{ statusText(order.status) }}</span>
          </td>
          <td>{{ order.createdAt | date : 'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ order.updatedAt | date : 'dd/MM/yyyy HH:mm' }}</td>

          <!-- Thao tác -->
          <td (click)="$event.stopPropagation()">
            <button
              *ngIf="canEdit(order)"
              class="btn btn-warning btn-sm py-2 px-3 me-1"
              [routerLink]="['/admin/order/edit', order._id]"
            >
              Sửa
            </button>

            <button
              *ngIf="canDelete(order)"
              class="btn btn-danger btn-sm py-2 px-3 me-1"
              (click)="deleteOrder(order._id, $event)"
            >
              Xóa
            </button>

            <!-- Nút In -->
            <button
              class="btn btn-info btn-sm py-2 px-3 text-white"
              (click)="printOrder(order)"
              title="In vận đơn"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                viewBox="0 0 16 16"
              >
                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z" />
                <path
                  d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5z"
                />
              </svg>
              In
            </button>
          </td>
        </tr>

        <!-- Chi tiết mở rộng -->
        <tr *ngIf="expandedOrderId === order._id">
          <td colspan="8">
            <div class="bg-dark text-white p-4 rounded-3">
              <h6 class="fw-bold text-warning mb-3">Chi tiết đơn hàng</h6>
              <div class="row">
                <div class="col-md-6">
                  <p><strong class="text-warning">Người gửi:</strong> {{ order.senderName }}</p>
                  <p>
                    <strong class="text-warning">Lấy hàng:</strong>
                    {{ formatAddress(order.pickupAddressId) }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p><strong class="text-warning">Người nhận:</strong> {{ order.receiverName }}</p>
                  <p>
                    <strong class="text-warning">Giao hàng:</strong>
                    {{ formatAddress(order.deliveryAddressId) }}
                  </p>
                </div>
              </div>
              <hr class="border-secondary" />
              <p>
                <strong>Dịch vụ:</strong> {{ order.serviceCode }} | <strong>COD:</strong>
                {{ order.codValue | number }} đ | <strong>Phí ship:</strong>
                {{ order.shippingFee | number }} đ | <strong>KL:</strong> {{ order.weightKg }} kg
              </p>

              <div *ngIf="order.items?.length">
                <h6 class="mt-3 text-info">Danh sách hàng hóa</h6>
                <table
                  class="table table-sm table-bordered table-striped mt-2 bg-secondary bg-opacity-25 text-white"
                >
                  <thead class="table-secondary text-dark">
                    <tr>
                      <th>Tên SP</th>
                      <th>SL</th>
                      <th>Đơn giá</th>
                      <th>Thành tiền</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let it of order.items">
                      <td>{{ it.productName }}</td>
                      <td>{{ it.quantity }}</td>
                      <td>{{ it.price | number }} đ</td>
                      <td>{{ it.quantity * it.price | number }} đ</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <div *ngIf="filteredOrders.length === 0" class="alert alert-info text-center mt-3">
    Không tìm thấy đơn hàng nào.
  </div>

  <!-- Pagination -->
  <nav *ngIf="filteredOrders.length >= pageSize">
    <ul class="pagination justify-content-center mt-3">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="changePage(currentPage - 1)">Trước</button>
      </li>
      <li class="page-item" *ngFor="let p of totalPages()" [class.active]="p === currentPage">
        <button class="page-link" (click)="changePage(p)">{{ p }}</button>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages().length">
        <button class="page-link" (click)="changePage(currentPage + 1)">Sau</button>
      </li>
    </ul>
  </nav>
</div>