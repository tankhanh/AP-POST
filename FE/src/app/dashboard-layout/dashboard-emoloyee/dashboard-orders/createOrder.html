<div class="container mt-4">
  <h4 class="fw-bold mb-3">Tạo đơn hàng mới</h4>

  <form [formGroup]="orderForm" (ngSubmit)="submit()">
    <div class="row g-4">
      <!-- CỘT TRÁI: Thông tin người gửi + địa chỉ lấy -->
      <div class="col-lg-6">
        <div class="mb-3">
          <label class="form-label fw-semibold">Người gửi</label>
          <input
            type="text"
            class="form-control"
            formControlName="senderName"
            placeholder="Nhập tên người gửi"
          />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Địa chỉ lấy hàng</label>
          <select
            class="form-select mb-2"
            formControlName="pickupProvinceId"
            (change)="onPickupProvinceChange()"
          >
            <option value="">-- Chọn tỉnh/thành phố --</option>
            <option *ngFor="let p of provinces" [value]="p._id">{{ p.name }}</option>
          </select>

          <select class="form-select mb-2" formControlName="pickupCommuneId">
            <option value="">-- Chọn phường/xã --</option>
            <option *ngFor="let c of pickupCommunes" [value]="c._id">{{ c.name }}</option>
          </select>

          <input
            type="text"
            class="form-control"
            formControlName="pickupDetailAddress"
            placeholder="Số nhà, tên đường..."
          />
        </div>
      </div>

      <!-- CỘT PHẢI: Thông tin người nhận + địa chỉ giao -->
      <div class="col-lg-6">
        <div class="mb-3">
          <label class="form-label fw-semibold">Người nhận</label>
          <input
            type="text"
            class="form-control"
            formControlName="receiverName"
            placeholder="Nhập tên người nhận"
          />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">SĐT người nhận</label>
          <input
            type="text"
            class="form-control"
            formControlName="receiverPhone"
            placeholder="0901234567"
          />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold"
            >Email người nhận <small class="text-muted">(không bắt buộc)</small></label
          >
          <input
            type="email"
            class="form-control"
            formControlName="email"
            placeholder="khach@gmail.com"
          />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Địa chỉ giao hàng</label>
          <select
            class="form-select mb-2"
            formControlName="deliveryProvinceId"
            (change)="onDeliveryProvinceChange()"
          >
            <option value="">-- Chọn tỉnh/thành phố --</option>
            <option *ngFor="let p of provinces" [value]="p._id">{{ p.name }}</option>
          </select>

          <select class="form-select mb-2" formControlName="deliveryCommuneId">
            <option value="">-- Chọn phường/xã --</option>
            <option *ngFor="let c of deliveryCommunes" [value]="c._id">{{ c.name }}</option>
          </select>

          <input
            type="text"
            class="form-control"
            formControlName="deliveryDetailAddress"
            placeholder="Số nhà, tên đường..."
          />
        </div>

        <!-- Dịch vụ + cân nặng + COD -->
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold">Dịch vụ</label>
            <select class="form-select" formControlName="serviceCode">
              <option value="STD">Tiêu chuẩn</option>
              <option value="EXP">Nhanh</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Khối lượng (kg)</label>
            <input
              type="number"
              step="0.1"
              min="0.01"
              class="form-control"
              formControlName="weightKg"
            />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Giá trị hàng (VNĐ)</label>
            <input type="number" class="form-control" formControlName="codValue" placeholder="0" />
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Ai trả phí vận chuyển?</label>
            <select class="form-select" formControlName="shippingFeePayer">
              <option value="SENDER">Người gửi</option>
              <option value="RECEIVER">Người nhận</option>
            </select>
          </div>
        </div>

        <div class="mb-3 mt-3">
          <label class="form-label fw-semibold">Ghi chú</label>
          <textarea
            class="form-control"
            rows="2"
            formControlName="details"
            placeholder="Giao giờ hành chính, gọi trước khi giao..."
          ></textarea>
        </div>

        <div class="alert alert-info">
          <strong>Phí vận chuyển: {{ shippingFee | number : '1.0-0' }} ₫</strong>
        </div>
        <div class="alert alert-warning">
          <strong>Người gửi trả tại quầy: {{ senderPay | number : '1.0-0' }} ₫</strong>
        </div>
        <div class="alert alert-success fs-4 fw-bold">
          <strong>Người nhận trả khi giao: {{ receiverPay | number : '1.0-0' }} ₫</strong>
          <small>(Bao gồm COD + phí nếu áp dụng)</small>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Phương thức thanh toán</label>
          <select class="form-select" formControlName="paymentMethod">
            <option value="CASH">Trả tiền tại quầy (người gửi)</option>
            <option value="COD">Thu hộ COD (người nhận)</option>
            <option value="BANK_TRANSFER">Chuyển khoản ngân hàng</option>
            <option value="FAKE" class="text-primary fw-bold">
              Thanh toán Fake (test - người gửi trả hết)
            </option>
          </select>
          <small class="text-muted">
            {{
              orderForm.get('paymentMethod')?.value === 'FAKE'
                ? 'Thanh toán fake để test – chuyển ngay sang trang thanh toán giả'
                : paymentNote
            }}
          </small>
        </div>
        <div class="alert alert-primary mt-3"><strong>Phương thức:</strong> {{ paymentNote }}</div>
      </div>
    </div>

    <!-- CHỈ CÒN 1 BẢN ĐỒ DUY NHẤT – SIÊU ĐẸP -->
    <div class="mt-4" *ngIf="orderForm.value.pickupLat && orderForm.value.deliveryLat">
      <app-dual-map
        [pickup]="{ lat: orderForm.value.pickupLat, lng: orderForm.value.pickupLng }"
        [delivery]="{ lat: orderForm.value.deliveryLat, lng: orderForm.value.deliveryLng }"
        (pickupMoved)="onPickupMoved($event)"
        (deliveryMoved)="onDeliveryMoved($event)"
        (locationChanged)="onLocationReverse($event)"
      >
      </app-dual-map>
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-danger btn-lg px-5" [disabled]="loading || orderForm.invalid">
        <span *ngIf="!loading">Tạo đơn hàng</span>
        <span *ngIf="loading">Đang tạo...</span>
      </button>
    </div>
  </form>
</div>
